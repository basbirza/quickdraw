<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Checkout - Quickdraw Pressing Co.</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://js.stripe.com/v3/"></script>
  <link href="https://fonts.googleapis.com/css2?family=Rye&display=swap" rel="stylesheet">
  <style>
    body { font-family: 'Georgia', 'Times New Roman', serif; }
    .logo-title { font-family: 'Rye', cursive; font-size: clamp(32px, 5vw, 52px); letter-spacing: 0.12em; }
    .logo-subtitle { font-family: Georgia, serif; letter-spacing: 0.3em; font-size: 10px; }
    #card-element {
      border: 1px solid #e5e7eb;
      padding: 12px;
      border-radius: 4px;
    }
    .StripeElement--focus {
      border-color: #000;
    }
  </style>
</head>
<body class="min-h-screen bg-gray-50 text-gray-900">

  <!-- Header -->
  <header class="bg-white border-b border-gray-200 px-4 md:px-8 py-5">
    <div class="text-center">
      <a href="index.html">
        <h1 class="logo-title">QUICKDRAW</h1>
        <div class="flex items-center justify-center gap-3 mt-1">
          <div class="h-px bg-gray-300 w-12 md:w-20"></div>
          <span class="text-xs tracking-widest text-gray-500 logo-subtitle">PRESSING CO.</span>
          <div class="h-px bg-gray-300 w-12 md:w-20"></div>
        </div>
      </a>
    </div>
  </header>

  <!-- Checkout Content -->
  <main class="max-w-6xl mx-auto px-4 md:px-8 py-8">
    <h1 class="text-2xl font-bold mb-8" style="letter-spacing: 0.1em;">SECURE CHECKOUT</h1>

    <div class="grid md:grid-cols-2 gap-8">

      <!-- Left Column: Forms -->
      <div>
        <form id="checkout-form">

          <!-- Customer Information -->
          <section class="bg-white p-6 mb-6 border border-gray-200">
            <h2 class="text-sm tracking-widest mb-4">CONTACT INFORMATION</h2>
            <div class="space-y-4">
              <div>
                <label class="block text-xs tracking-wider text-gray-600 mb-1">EMAIL *</label>
                <input type="email" name="customer_email" required
                  class="w-full border border-gray-300 px-3 py-2 text-sm focus:outline-none focus:border-black">
              </div>
              <div class="grid grid-cols-2 gap-4">
                <div>
                  <label class="block text-xs tracking-wider text-gray-600 mb-1">FIRST NAME *</label>
                  <input type="text" name="customer_first_name" required
                    class="w-full border border-gray-300 px-3 py-2 text-sm focus:outline-none focus:border-black">
                </div>
                <div>
                  <label class="block text-xs tracking-wider text-gray-600 mb-1">LAST NAME *</label>
                  <input type="text" name="customer_last_name" required
                    class="w-full border border-gray-300 px-3 py-2 text-sm focus:outline-none focus:border-black">
                </div>
              </div>
              <div>
                <label class="block text-xs tracking-wider text-gray-600 mb-1">PHONE (OPTIONAL)</label>
                <input type="tel" name="customer_phone"
                  class="w-full border border-gray-300 px-3 py-2 text-sm focus:outline-none focus:border-black">
              </div>
            </div>
          </section>

          <!-- Shipping Address -->
          <section class="bg-white p-6 mb-6 border border-gray-200">
            <h2 class="text-sm tracking-widest mb-4">SHIPPING ADDRESS</h2>
            <div class="space-y-4">
              <div>
                <label class="block text-xs tracking-wider text-gray-600 mb-1">ADDRESS *</label>
                <input type="text" name="billing_address_line1" required
                  class="w-full border border-gray-300 px-3 py-2 text-sm focus:outline-none focus:border-black">
              </div>
              <div>
                <label class="block text-xs tracking-wider text-gray-600 mb-1">APARTMENT, SUITE, ETC. (OPTIONAL)</label>
                <input type="text" name="billing_address_line2"
                  class="w-full border border-gray-300 px-3 py-2 text-sm focus:outline-none focus:border-black">
              </div>
              <div class="grid grid-cols-2 gap-4">
                <div>
                  <label class="block text-xs tracking-wider text-gray-600 mb-1">POSTAL CODE *</label>
                  <input type="text" name="billing_postal_code" required
                    class="w-full border border-gray-300 px-3 py-2 text-sm focus:outline-none focus:border-black">
                </div>
                <div>
                  <label class="block text-xs tracking-wider text-gray-600 mb-1">CITY *</label>
                  <input type="text" name="billing_city" required
                    class="w-full border border-gray-300 px-3 py-2 text-sm focus:outline-none focus:border-black">
                </div>
              </div>
              <div>
                <label class="block text-xs tracking-wider text-gray-600 mb-1">COUNTRY *</label>
                <select name="billing_country" required
                  class="w-full border border-gray-300 px-3 py-2 text-sm focus:outline-none focus:border-black">
                  <option value="NL">Netherlands</option>
                  <option value="DE">Germany</option>
                  <option value="BE">Belgium</option>
                  <option value="FR">France</option>
                  <option value="IT">Italy</option>
                  <option value="ES">Spain</option>
                  <option value="AT">Austria</option>
                  <option value="LU">Luxembourg</option>
                </select>
              </div>
            </div>
          </section>

          <!-- Payment -->
          <section class="bg-white p-6 mb-6 border border-gray-200">
            <h2 class="text-sm tracking-widest mb-4">PAYMENT</h2>
            <div class="mb-4">
              <div class="flex items-center gap-2 mb-3">
                <svg width="32" height="20" viewBox="0 0 32 20" fill="none"><rect width="32" height="20" rx="3" fill="#635BFF"/><text x="16" y="14" text-anchor="middle" fill="white" font-size="10" font-family="sans-serif">Stripe</text></svg>
                <span class="text-xs text-gray-600">Secure payment powered by Stripe</span>
              </div>
              <div id="card-element"></div>
              <div id="card-errors" class="text-xs text-red-500 mt-2"></div>
            </div>
            <div class="text-xs text-gray-500 bg-gray-50 p-3 border border-gray-200">
              üîí Your payment information is encrypted and secure. We never store your card details.
            </div>
          </section>

          <!-- Submit Button -->
          <button type="submit" id="submit-button"
            class="w-full bg-black text-white py-4 text-xs tracking-widest hover:bg-gray-800 transition-colors disabled:bg-gray-400 disabled:cursor-not-allowed">
            COMPLETE ORDER
          </button>

          <p class="text-xs text-center text-gray-500 mt-4">
            By completing your order, you agree to our <a href="terms.html" class="underline">Terms & Conditions</a>
          </p>

        </form>
      </div>

      <!-- Right Column: Order Summary -->
      <div>
        <section class="bg-white p-6 border border-gray-200 sticky top-4">
          <h2 class="text-sm tracking-widest mb-4">ORDER SUMMARY</h2>

          <div id="order-items" class="space-y-4 mb-6">
            <!-- Cart items will be loaded here -->
          </div>

          <div class="border-t border-gray-200 pt-4 space-y-2 text-sm">
            <div class="flex justify-between">
              <span class="text-gray-600">Subtotal</span>
              <span id="subtotal">‚Ç¨0</span>
            </div>
            <div class="flex justify-between">
              <span class="text-gray-600">Shipping</span>
              <span id="shipping" class="text-green-600">FREE</span>
            </div>
            <div class="flex justify-between font-bold text-base pt-2 border-t border-gray-200">
              <span>Total</span>
              <span id="total">‚Ç¨0</span>
            </div>
          </div>

          <div class="mt-6">
            <a href="index.html" class="block text-center text-xs tracking-widest text-gray-500 hover:text-black py-2 border border-gray-300 hover:border-black transition-all">
              ‚Üê CONTINUE SHOPPING
            </a>
          </div>
        </section>
      </div>

    </div>
  </main>

  <script src="cart.js"></script>
  <script>
    // Configuration
    const API_URL = 'http://localhost:8000/api';
    const STRIPE_PUBLIC_KEY = 'pk_test_51SzEgXHpagxIXRdRKIZOVi7RROKWpA3dr4EZbq5jD7hLxWIunWPYnKXwY34XBki7lX6EpYfXIlL78GjJY0eXVBpl00qDgMe3n9';

    // Initialize Stripe
    const stripe = Stripe(STRIPE_PUBLIC_KEY);
    const elements = stripe.elements();
    const cardElement = elements.create('card', {
      style: {
        base: {
          fontSize: '14px',
          color: '#111',
          fontFamily: 'Georgia, serif',
          '::placeholder': { color: '#9ca3af' }
        }
      }
    });
    cardElement.mount('#card-element');

    // Handle card errors
    cardElement.on('change', (event) => {
      const displayError = document.getElementById('card-errors');
      displayError.textContent = event.error ? event.error.message : '';
    });

    // Load cart items
    function loadCart() {
      const cart = QuickdrawCart ? JSON.parse(localStorage.getItem('quickdraw_cart') || '[]') : [];

      if (cart.length === 0) {
        window.location.href = 'index.html';
        return;
      }

      const itemsContainer = document.getElementById('order-items');
      let subtotal = 0;

      cart.forEach(item => {
        const itemTotal = item.priceNum * item.qty;
        subtotal += itemTotal;

        itemsContainer.innerHTML += `
          <div class="flex gap-3 pb-4 border-b border-gray-100">
            <div class="w-20 h-24 bg-gray-100 flex-shrink-0">
              ${item.image ? `<img src="${item.image}" class="w-full h-full object-contain" />` : ''}
            </div>
            <div class="flex-1 min-w-0">
              <p class="text-sm font-medium">${item.name}</p>
              <p class="text-xs text-gray-500">${item.desc}</p>
              <p class="text-xs text-gray-500 mt-1">Size: ${item.size} ¬∑ Qty: ${item.qty}</p>
              <p class="text-sm mt-2">‚Ç¨${itemTotal.toFixed(0)}</p>
            </div>
          </div>
        `;
      });

      // Calculate totals
      const shipping = subtotal >= 150 ? 0 : 9.95;
      const total = subtotal + shipping;

      document.getElementById('subtotal').textContent = '‚Ç¨' + subtotal.toFixed(2);
      document.getElementById('shipping').textContent = shipping === 0 ? 'FREE' : '‚Ç¨' + shipping.toFixed(2);
      document.getElementById('total').textContent = '‚Ç¨' + total.toFixed(2);

      return { cart, subtotal, shipping, total };
    }

    // Form submission
    const form = document.getElementById('checkout-form');
    const submitButton = document.getElementById('submit-button');

    form.addEventListener('submit', async (e) => {
      e.preventDefault();

      submitButton.disabled = true;
      submitButton.textContent = 'PROCESSING...';

      try {
        // Create payment method with Stripe
        const { paymentMethod, error } = await stripe.createPaymentMethod({
          type: 'card',
          card: cardElement,
          billing_details: {
            name: form.customer_first_name.value + ' ' + form.customer_last_name.value,
            email: form.customer_email.value,
            phone: form.customer_phone.value,
            address: {
              line1: form.billing_address_line1.value,
              line2: form.billing_address_line2.value,
              city: form.billing_city.value,
              postal_code: form.billing_postal_code.value,
              country: form.billing_country.value,
            }
          }
        });

        if (error) {
          throw new Error(error.message);
        }

        // Prepare order data
        const cart = JSON.parse(localStorage.getItem('quickdraw_cart') || '[]');

        // Map cart items to order items with product IDs
        const orderItems = cart.map(item => {
          const productId = getProductIdFromCart(item);
          if (!productId) {
            throw new Error(`Product "${item.name}" not found in catalog. Please refresh and try again.`);
          }
          return {
            product_id: productId,
            size: item.size || 'One Size',
            quantity: item.qty
          };
        });

        const orderData = {
          items: orderItems,
          customer_email: form.customer_email.value,
          customer_first_name: form.customer_first_name.value,
          customer_last_name: form.customer_last_name.value,
          customer_phone: form.customer_phone.value || null,
          billing_address_line1: form.billing_address_line1.value,
          billing_address_line2: form.billing_address_line2.value || null,
          billing_city: form.billing_city.value,
          billing_postal_code: form.billing_postal_code.value,
          billing_country: form.billing_country.value,
          payment_method: 'stripe',
          payment_token: paymentMethod.id
        };

        // Submit to backend API (include auth token if logged in)
        const authToken = localStorage.getItem('auth_token');
        const headers = {
          'Content-Type': 'application/json',
        };

        if (authToken) {
          headers['Authorization'] = `Bearer ${authToken}`;
        }

        const response = await fetch(`${API_URL}/orders`, {
          method: 'POST',
          headers: headers,
          body: JSON.stringify(orderData)
        });

        const result = await response.json();

        if (result.success) {
          // Save email for confirmation page
          sessionStorage.setItem('checkout_email', form.customer_email.value);

          // Clear cart
          localStorage.removeItem('quickdraw_cart');

          // Redirect to confirmation
          localStorage.setItem('order_confirmation', JSON.stringify(result));
          window.location.href = 'order-confirmation.html?order=' + result.order_number;
        } else {
          throw new Error(result.message || 'Order failed');
        }

      } catch (error) {
        alert('Payment failed: ' + error.message);
        submitButton.disabled = false;
        submitButton.textContent = 'COMPLETE ORDER';
      }
    });

    // Fetch all products from API to match cart items with IDs
    let productsCache = [];

    async function loadProducts() {
      try {
        const response = await fetch(`${API_URL}/products?per_page=100`);
        const data = await response.json();
        productsCache = data.data;
      } catch (error) {
        console.error('Failed to load products:', error);
      }
    }

    // Helper to get product ID by matching name
    function getProductIdFromCart(item) {
      const product = productsCache.find(p =>
        p.name.toLowerCase() === item.name.toLowerCase()
      );
      return product ? product.id : null;
    }

    // Load cart on page load
    document.addEventListener('DOMContentLoaded', async () => {
      // Load products from API first
      await loadProducts();

      const cartData = loadCart();
      if (!cartData) {
        alert('Your cart is empty');
        window.location.href = 'index.html';
      }
    });
  </script>

</body>
</html>
